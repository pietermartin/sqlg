


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TestReducing</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.umlg.sqlg.test.reducing</a>
</div>

<h1>Coverage Summary for Class: TestReducing (org.umlg.sqlg.test.reducing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TestReducing</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (65/65)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (67/134)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.7%
  </span>
  <span class="absValue">
    (1038/1052)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TestReducing$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$10</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$3</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$5</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$6</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$7</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$8</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestReducing$9</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (75/75)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (67/134)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.7%
  </span>
  <span class="absValue">
    (1069/1083)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.umlg.sqlg.test.reducing;
&nbsp;
&nbsp;import org.apache.commons.collections4.set.ListOrderedSet;
&nbsp;import org.apache.tinkerpop.gremlin.process.AbstractGremlinProcessTest;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.Scope;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.Traversal;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.GraphTraversalSource;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.__;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.step.map.GroupStep;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.strategy.decoration.SubgraphStrategy;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.util.DefaultTraversal;
&nbsp;import org.apache.tinkerpop.gremlin.structure.Edge;
&nbsp;import org.apache.tinkerpop.gremlin.structure.T;
&nbsp;import org.apache.tinkerpop.gremlin.structure.Vertex;
&nbsp;import org.junit.Assert;
&nbsp;import org.junit.Before;
&nbsp;import org.junit.Test;
&nbsp;import org.umlg.sqlg.step.SqlgGraphStep;
&nbsp;import org.umlg.sqlg.step.SqlgGroupStep;
&nbsp;import org.umlg.sqlg.step.SqlgPropertiesStep;
&nbsp;import org.umlg.sqlg.step.barrier.*;
&nbsp;import org.umlg.sqlg.structure.PropertyDefinition;
&nbsp;import org.umlg.sqlg.structure.PropertyType;
&nbsp;import org.umlg.sqlg.test.BaseTest;
&nbsp;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.Statement;
&nbsp;import java.util.*;
&nbsp;
&nbsp;/**
&nbsp; * @author &lt;a href=&quot;https://github.com/pietermartin&quot;&gt;Pieter Martin&lt;/a&gt;
&nbsp; * Date: 2018/11/17
&nbsp; */
&nbsp;@SuppressWarnings({&quot;Duplicates&quot;, &quot;unchecked&quot;, &quot;rawtypes&quot;, &quot;resource&quot;})
<b class="fc">&nbsp;public class TestReducing extends BaseTest {</b>
&nbsp;
&nbsp;    @Before
&nbsp;    public void before() throws Exception {
<b class="fc">&nbsp;        super.before();</b>
<b class="pc">&nbsp;        if (isHsqldb()) {</b>
<b class="nc">&nbsp;            Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="nc">&nbsp;            Statement statement = connection.createStatement();</b>
<b class="nc">&nbsp;            statement.execute(&quot;SET DATABASE SQL AVG SCALE 2&quot;);</b>
<b class="nc">&nbsp;            this.sqlgGraph.tx().commit();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testRepeatAndMin() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Integer&gt; traversal = this.sqlgGraph.traversal().V().repeat(__.both()).times(5).values(&quot;age&quot;).min();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        checkResults(List.of(27), traversal);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_repeatXbothXfollowedByXX_timesX2X_group_byXsongTypeX_byXcountX() {
<b class="fc">&nbsp;        loadGratefulDead();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Long&gt;&gt; traversal = this.sqlgGraph.traversal().V().repeat(__.both(&quot;followedBy&quot;)).times(2).&lt;String, Long&gt;group().by(&quot;songType&quot;).by(__.count());</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Map&lt;String, Long&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        AbstractGremlinProcessTest.checkMap(new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;original&quot;, 771317L);</b>
<b class="fc">&nbsp;            put(&quot;&quot;, 160968L);</b>
<b class="fc">&nbsp;            put(&quot;cover&quot;, 368579L);</b>
&nbsp;        }}, result);
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        AbstractGremlinProcessTest.checkSideEffects(traversal.asAdmin().getSideEffects());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupCountNoBySomething() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Long, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Long, Long&gt;&gt;) this.sqlgGraph.traversal().V().&lt;Long&gt;groupCount().by(__.bothE().count());</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        List&lt;Map&lt;Long, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.get(0).size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).values().stream().allMatch(a -&gt; a == 6L));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupCountNoBy() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt;) sqlgGraph.traversal().V()</b>
<b class="fc">&nbsp;                .groupCount();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        List&lt;Map&lt;Object, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, result.get(0).size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).values().stream().allMatch(a -&gt; a == 1L));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupCount() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt;) this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).groupCount().by(&quot;name&quot;);</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        List&lt;Map&lt;Object, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, result.get(0).get(&quot;a&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.get(0).get(&quot;b&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupCountByLabel() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt;) this.sqlgGraph.traversal().V().groupCount().by(T.label);</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String sql1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_B&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql3 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_C&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!sql1.equals(sql) &amp;&amp; !sql2.equals(sql) &amp;&amp; !sql3.equals(sql)) {</b>
<b class="nc">&nbsp;                Assert.fail(sql + &quot; not found&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        List&lt;Map&lt;Object, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, result.get(0).size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;C&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(3L, result.get(0).get(&quot;A&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2L, result.get(0).get(&quot;B&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(1L, result.get(0).get(&quot;C&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupByCountLabel() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt;) this.sqlgGraph.traversal().V()</b>
<b class="fc">&nbsp;                .&lt;Object, Long&gt;group().by(T.label).by(__.count());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String sql1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A\&quot;&quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_B\&quot;&quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql3 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_C\&quot;&quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!sql1.equals(sql) &amp;&amp; !sql2.equals(sql) &amp;&amp; !sql3.equals(sql)) {</b>
<b class="nc">&nbsp;                Assert.fail(sql + &quot; not found&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        List&lt;Map&lt;Object, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, result.get(0).size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;C&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(3L, result.get(0).get(&quot;A&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2L, result.get(0).get(&quot;B&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(1L, result.get(0).get(&quot;C&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupByCount() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt; traversal = (DefaultTraversal&lt;Vertex, Map&lt;Object, Long&gt;&gt;) this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;)</b>
<b class="fc">&nbsp;                .&lt;Object, Long&gt;group().by(&quot;name&quot;).by(__.count());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot;.&quot;name&quot; AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        List&lt;Map&lt;Object, Long&gt;&gt; result = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;a&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.get(0).containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(2L, result.get(0).get(&quot;a&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(1L, result.get(0).get(&quot;b&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMax() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 1, &quot;x&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 2, &quot;x&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 3, &quot;x&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 0, &quot;x&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.next(), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverOnePropertyMax() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Integer&gt;group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).max());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, result.get(&quot;A&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, result.get(&quot;B&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMaxOnString() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;b&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;d&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;c&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, String&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;d&quot;, traversal.next());</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;Duplicates&quot;)
&nbsp;    @Test
&nbsp;    public void testMin() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 0);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).min();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMIN(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMinGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertEquals(0, traversal.next(), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMinOnString() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;b&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;c&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, &quot;d&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, String&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).min();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMIN(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMinGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;a&quot;, traversal.next());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testSum() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).sum();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tSUM(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgSumGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, traversal.next(), 0L);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMean() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 0);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Double&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).values(&quot;age&quot;).mean();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tAVG(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;, COUNT(1) AS &quot;alias1_weight&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgAvgGlobalStep);</b>
<b class="fc">&nbsp;        Double d = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1.5, d, 0D);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_age_mean() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Double&gt; t1 = sqlgGraph.traversal().V().values(&quot;age&quot;).mean();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Double&gt; t2 = sqlgGraph.traversal().V().values(&quot;age&quot;).fold().mean(Scope.local);</b>
<b class="fc">&nbsp;        for (final Traversal&lt;Vertex, Double&gt; traversal : Arrays.asList(t1, t2)) {</b>
<b class="fc">&nbsp;            printTraversalForm(traversal);</b>
<b class="fc">&nbsp;            final Double mean = traversal.next();</b>
<b class="fc">&nbsp;            Assert.assertEquals(30.75, mean, 0.05);</b>
<b class="fc">&nbsp;            Assert.assertFalse(traversal.hasNext());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_foo_mean() {
<b class="fc">&nbsp;        loadModern();</b>
&nbsp;
<b class="fc">&nbsp;        Traversal&lt;Vertex, Number&gt; t1 = sqlgGraph.traversal().V().values(&quot;foo&quot;).mean();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Number&gt; t2 = sqlgGraph.traversal().V().values(&quot;foo&quot;).fold().mean(Scope.local);</b>
<b class="fc">&nbsp;        for (final Traversal&lt;Vertex, Number&gt; traversal : Arrays.asList(t1, t2)) {</b>
<b class="fc">&nbsp;            printTraversalForm(traversal);</b>
<b class="fc">&nbsp;            Assert.assertFalse(traversal.hasNext());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_hasLabelXsoftwareX_group_byXnameX_byXbothE_weight_meanX() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Number&gt;&gt; traversal = this.sqlgGraph.traversal().V().hasLabel(&quot;software&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Number&gt;group().by(&quot;name&quot;).by(__.bothE().values(&quot;weight&quot;).mean());</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        final Map&lt;String, Number&gt; map = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, map.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(1.0, map.get(&quot;ripple&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(1.0 / 3, map.get(&quot;lop&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverOnePropertyMin() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Integer&gt;group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).min());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tMIN(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.get(&quot;A&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, result.get(&quot;B&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverOnePropertySum() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Long&gt;&gt; traversal = (DefaultTraversal) sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Long&gt;group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).sum());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tSUM(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Long&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, result.get(&quot;A&quot;), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, result.get(&quot;B&quot;), 0L);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverOnePropertyMean() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Double&gt;&gt; traversal = (DefaultTraversal) sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Double&gt;group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).mean());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tAVG(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias2&quot;, COUNT(1) AS &quot;alias2_weight&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Double&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;B&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(2.0, result.get(&quot;A&quot;), 0D);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3.0, result.get(&quot;B&quot;), 0D);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverTwoPropertiesWithValues() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;surname&quot;, &quot;C&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;surname&quot;, &quot;D&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;surname&quot;, &quot;C&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;surname&quot;, &quot;E&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;C&quot;, &quot;surname&quot;, &quot;E&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;List&lt;String&gt;, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;List&lt;String&gt;, Integer&gt;group()</b>
<b class="fc">&nbsp;                .by(__.values(&quot;name&quot;, &quot;surname&quot;).fold())</b>
<b class="fc">&nbsp;                .by(__.values(&quot;age&quot;).max());</b>
&nbsp;
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;surname&quot; AS &quot;alias1&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias2&quot;,
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;surname\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;List&lt;String&gt;, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        System.out.println(result);</b>
&nbsp;
<b class="pc">&nbsp;        Assert.assertTrue(result.containsKey(Arrays.asList(&quot;A&quot;, &quot;C&quot;)) || result.containsKey(Arrays.asList(&quot;C&quot;, &quot;A&quot;)));</b>
<b class="pc">&nbsp;        Assert.assertTrue(result.containsKey(Arrays.asList(&quot;B&quot;, &quot;D&quot;)) || result.containsKey(Arrays.asList(&quot;D&quot;, &quot;B&quot;)));</b>
<b class="pc">&nbsp;        Assert.assertTrue(result.containsKey(Arrays.asList(&quot;B&quot;, &quot;E&quot;)) || result.containsKey(Arrays.asList(&quot;E&quot;, &quot;B&quot;)));</b>
<b class="pc">&nbsp;        Assert.assertTrue(result.containsKey(Arrays.asList(&quot;C&quot;, &quot;E&quot;)) || result.containsKey(Arrays.asList(&quot;E&quot;, &quot;C&quot;)));</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, result.size());</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;
<b class="pc">&nbsp;        if (result.containsKey(Arrays.asList(&quot;A&quot;, &quot;C&quot;))) {</b>
<b class="nc">&nbsp;            Assert.assertEquals(3, result.get(Arrays.asList(&quot;A&quot;, &quot;C&quot;)), 0);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            Assert.assertEquals(3, result.get(Arrays.asList(&quot;C&quot;, &quot;A&quot;)), 0);</b>
&nbsp;        }
<b class="pc">&nbsp;        if (result.containsKey(Arrays.asList(&quot;B&quot;, &quot;D&quot;))) {</b>
<b class="nc">&nbsp;            Assert.assertEquals(2, result.get(Arrays.asList(&quot;B&quot;, &quot;D&quot;)), 0);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            Assert.assertEquals(2, result.get(Arrays.asList(&quot;D&quot;, &quot;B&quot;)), 0);</b>
&nbsp;        }
<b class="pc">&nbsp;        if (result.containsKey(Arrays.asList(&quot;B&quot;, &quot;E&quot;))) {</b>
<b class="nc">&nbsp;            Assert.assertEquals(4, result.get(Arrays.asList(&quot;B&quot;, &quot;E&quot;)), 0);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            Assert.assertEquals(4, result.get(Arrays.asList(&quot;E&quot;, &quot;B&quot;)), 0);</b>
&nbsp;        }
<b class="pc">&nbsp;        if (result.containsKey(Arrays.asList(&quot;C&quot;, &quot;E&quot;))) {</b>
<b class="nc">&nbsp;            Assert.assertEquals(5, result.get(Arrays.asList(&quot;C&quot;, &quot;E&quot;)), 0);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            Assert.assertEquals(5, result.get(Arrays.asList(&quot;E&quot;, &quot;C&quot;)), 0);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;ArraysAsListWithZeroOrOneArgument&quot;)
&nbsp;    @Test
&nbsp;    public void testGroupOverTwoPropertiesWithValueMap() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;surname&quot;, &quot;C&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;surname&quot;, &quot;D&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;surname&quot;, &quot;C&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;surname&quot;, &quot;E&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;C&quot;, &quot;surname&quot;, &quot;E&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;Map&lt;String, List&lt;String&gt;&gt;, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .&lt;Map&lt;String, List&lt;String&gt;&gt;, Integer&gt;group()</b>
<b class="fc">&nbsp;                .by(__.valueMap(&quot;name&quot;, &quot;surname&quot;))</b>
<b class="fc">&nbsp;                .by(__.values(&quot;age&quot;).max());</b>
&nbsp;
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;surname&quot; AS &quot;alias1&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot; AS &quot;alias2&quot;,
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;name&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot;.&quot;surname\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;Map&lt;String, List&lt;String&gt;&gt;, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        System.out.println(result);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;C&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;A&quot;));</b>
&nbsp;        }}));
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;D&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;B&quot;));</b>
&nbsp;        }}));
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;E&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;B&quot;));</b>
&nbsp;        }}));
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;E&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;C&quot;));</b>
&nbsp;        }}));
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(3, result.get(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;C&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;A&quot;));</b>
&nbsp;        }}), 0);
<b class="fc">&nbsp;        Assert.assertEquals(2, result.get(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;D&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;B&quot;));</b>
&nbsp;        }}), 0);
<b class="fc">&nbsp;        Assert.assertEquals(4, result.get(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;E&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;B&quot;));</b>
&nbsp;        }}), 0);
<b class="fc">&nbsp;        Assert.assertEquals(5, result.get(new HashMap&lt;String, List&lt;String&gt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;surname&quot;, Arrays.asList(&quot;E&quot;));</b>
<b class="fc">&nbsp;            put(&quot;name&quot;, Arrays.asList(&quot;C&quot;));</b>
&nbsp;        }}), 0);
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupOverOnePropertyWithJoin() {
<b class="fc">&nbsp;        Vertex person = this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;);</b>
<b class="fc">&nbsp;        Vertex address1 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;A&quot;, &quot;year&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex address2 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;A&quot;, &quot;year&quot;, 4);</b>
<b class="fc">&nbsp;        Vertex address3 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;C&quot;, &quot;year&quot;, 6);</b>
<b class="fc">&nbsp;        Vertex address4 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;D&quot;, &quot;year&quot;, 8);</b>
<b class="fc">&nbsp;        Vertex address5 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;D&quot;, &quot;year&quot;, 7);</b>
<b class="fc">&nbsp;        Vertex address6 = this.sqlgGraph.addVertex(T.label, &quot;Address&quot;, &quot;name&quot;, &quot;D&quot;, &quot;year&quot;, 6);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address1);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address2);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address3);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address4);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address5);</b>
<b class="fc">&nbsp;        person.addEdge(&quot;livesAt&quot;, address6);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;Person&quot;)</b>
<b class="fc">&nbsp;                .out(&quot;livesAt&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Integer&gt;group()</b>
<b class="fc">&nbsp;                .by(&quot;name&quot;)</b>
<b class="fc">&nbsp;                .by(__.values(&quot;year&quot;).max());</b>
&nbsp;
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Address&quot;.&quot;year&quot;) AS &quot;alias1&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_Address&quot;.&quot;name&quot; AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_livesAt&quot; ON &quot;public&quot;.&quot;V_Person&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_livesAt&quot;.&quot;public.Person__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_Address&quot; ON &quot;public&quot;.&quot;E_livesAt&quot;.&quot;public.Address__I&quot; = &quot;public&quot;.&quot;V_Address&quot;.&quot;ID&quot;
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_Address&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;A&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;C&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;D&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, result.get(&quot;A&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, result.get(&quot;C&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(8, result.get(&quot;D&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupByLabelMax() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 10);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 20);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;C&quot;, &quot;age&quot;, 100);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name&quot;, &quot;D&quot;, &quot;age&quot;, 40);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Dog&quot;, &quot;name&quot;, &quot;A&quot;, &quot;age&quot;, 10);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Dog&quot;, &quot;name&quot;, &quot;B&quot;, &quot;age&quot;, 200);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Dog&quot;, &quot;name&quot;, &quot;C&quot;, &quot;age&quot;, 30);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Dog&quot;, &quot;name&quot;, &quot;D&quot;, &quot;age&quot;, 40);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().&lt;String, Integer&gt;group().by(T.label).by(__.values(&quot;age&quot;).max());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String sql1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_Dog&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Dog&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(&quot;public&quot;.&quot;V_Person&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_Person&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!sql1.equals(sql) &amp;&amp; !sql2.equals(sql)) {</b>
<b class="nc">&nbsp;                Assert.fail(sql + &quot; not found&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;Person&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;Dog&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(100, result.get(&quot;Person&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(200, result.get(&quot;Dog&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 7);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;aa&quot;).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(a2.&quot;alias2&quot;)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot; AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Integer max = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(7, max, 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathQuery2() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 7);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a4);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a1);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;aa&quot;).out(&quot;aa&quot;).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(a3.&quot;alias3&quot;)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot; INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias2&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot; AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a3 ON a2.&quot;public.E_aa.public.A__I&quot; = a3.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Integer max = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(7, max, 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathQuery3() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b2&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b3&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;c1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;c2&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;c3&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).values(&quot;age&quot;).sum();</b>
&nbsp;        @SuppressWarnings(&quot;unused&quot;)
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgSumGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Long max = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(12, max, 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupCountQuery2() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 0);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Long&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).count());</b>
&nbsp;        @SuppressWarnings(&quot;unused&quot;)
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof GroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Long&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Long l = result.get(&quot;b&quot;);</b>
<b class="fc">&nbsp;        Assert.assertEquals(7L, l, 0L);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupCountQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Long&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.count());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;,
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name&quot; AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;
&nbsp;                    WHERE
&nbsp;                    \t( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Long&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(7, result.get(&quot;b&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupSumQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Long&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).sum());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tSUM(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;
&nbsp;                    WHERE
&nbsp;                    \t( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Long&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(15, result.get(&quot;b&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupMaxQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).max());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tMAX(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;
&nbsp;                    WHERE
&nbsp;                    \t( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, result.get(&quot;b&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupMinQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 0);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).min());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tMIN(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;
&nbsp;                    WHERE
&nbsp;                    \t( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(0, result.get(&quot;b&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathQueryMean() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a3, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a4, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a1, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a3, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Double&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;aa&quot;).out(&quot;aa&quot;).values(&quot;age&quot;).mean();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	AVG(a3.&quot;alias3&quot;), COUNT(1) AS &quot;alias3_weight&quot;\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot; INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias2&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot; AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a3 ON a2.&quot;public.E_aa.public.A__I&quot; = a3.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgAvgGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Double mean = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, mean, 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicatePathGroupMeanQuery() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex c1 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 0);</b>
<b class="fc">&nbsp;        Vertex c2 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex c3 = this.sqlgGraph.addVertex(T.label, &quot;C&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ac&quot;, c3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Double&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out(&quot;ab&quot;, &quot;ac&quot;).group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).mean());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name&quot; AS &quot;alias1&quot;,
&nbsp;                    \tAVG(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias2&quot;, COUNT(1) AS &quot;alias2_weight&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;
&nbsp;                    WHERE
&nbsp;                    \t( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    GROUP BY
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;.&quot;name\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Map&lt;String, Double&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;b&quot;));</b>
<b class="fc">&nbsp;        Double d = result.get(&quot;b&quot;);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2.142857142857143D, d, 0D);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testGroupByDuplicatePaths() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        Vertex a5 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        Vertex a6 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 6);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a5);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a6);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V(a1).out().&lt;String, Integer&gt;group().by(&quot;name&quot;).by(__.values(&quot;age&quot;).max());</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	a2.&quot;alias2&quot;, MAX(a2.&quot;alias3&quot;)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;name&quot; AS &quot;alias2&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot; AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot;
&nbsp;                    GROUP BY
&nbsp;                    	a2.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgGroupStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; result = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, result.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;a2&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, result.get(&quot;a2&quot;), 0);</b>
<b class="fc">&nbsp;        Assert.assertTrue(result.containsKey(&quot;a3&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, result.get(&quot;a3&quot;), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void duplicateQueryMax() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(</b>
&nbsp;                    (&quot;&quot;&quot;
&nbsp;                            SELECT
&nbsp;                            	MAX(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                            FROM
&nbsp;                            	&quot;public&quot;.&quot;V_B&quot;\
<b class="pc">&nbsp;                            &quot;&quot;&quot;.equals(sql)) ||</b>
&nbsp;                            (&quot;&quot;&quot;
&nbsp;                                    SELECT
&nbsp;                                    	MAX(&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                                    FROM
&nbsp;                                    	&quot;public&quot;.&quot;V_A&quot;\
<b class="fc">&nbsp;                                    &quot;&quot;&quot;.equals(sql))</b>
&nbsp;            );
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void duplicateQueryMin() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().values(&quot;age&quot;).min();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="fc">&nbsp;        String s1 = &quot;&quot;&quot;</b>
&nbsp;                SELECT
&nbsp;                \tMIN(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                FROM
&nbsp;                \t&quot;public&quot;.&quot;V_B&quot;\
&nbsp;                &quot;&quot;&quot;;
<b class="fc">&nbsp;        String s2 = &quot;&quot;&quot;</b>
&nbsp;                SELECT
&nbsp;                \tMIN(&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                FROM
&nbsp;                \t&quot;public&quot;.&quot;V_A&quot;\
&nbsp;                &quot;&quot;&quot;;
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="pc">&nbsp;            Assert.assertTrue(s1.equals(sql) || s2.equals(sql));</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMinGlobalStep);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(1, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void duplicateQuerySum() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().values(&quot;age&quot;).sum();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String sql1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tSUM(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_B\&quot;&quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tSUM(&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A\&quot;&quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!sql1.equals(sql) &amp;&amp; !sql2.equals(sql)) {</b>
<b class="nc">&nbsp;                Assert.fail(sql + &quot; not found&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgSumGlobalStep);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void duplicateQueryMean() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;age&quot;, 1);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Double&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().values(&quot;age&quot;).mean();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String s1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tAVG(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias1&quot;, COUNT(1) AS &quot;alias1_weight&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="fc">&nbsp;            String s2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tAVG(&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot;) AS &quot;alias1&quot;, COUNT(1) AS &quot;alias1_weight&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!(s1.equals(sql) || s2.equals(sql.trim()))) {</b>
<b class="nc">&nbsp;                Assert.fail(sql);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgAvgGlobalStep);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(1.8, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testDuplicateQueryNoLabel() {
<b class="fc">&nbsp;        Vertex p1 = this.sqlgGraph.addVertex(T.label, &quot;person&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex p2 = this.sqlgGraph.addVertex(T.label, &quot;person&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        p1.addEdge(&quot;knows&quot;, p2);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Double&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;person&quot;).out().out().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(a3.&quot;alias3&quot;)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_knows&quot;.&quot;public.person__I&quot; AS &quot;public.E_knows.public.person__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_knows&quot; ON &quot;public&quot;.&quot;V_person&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_knows&quot;.&quot;public.person__O&quot;
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;E_knows&quot;.&quot;public.person__I&quot; AS &quot;public.E_knows.public.person__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_knows&quot; ON &quot;public&quot;.&quot;V_person&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_knows&quot;.&quot;public.person__O&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_knows.public.person__I&quot; = a2.&quot;alias1&quot; INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot;.&quot;ID&quot; AS &quot;alias2&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot;.&quot;age&quot; AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_person&quot;
&nbsp;                    ) a3 ON a2.&quot;public.E_knows.public.person__I&quot; = a3.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Number m = traversal.next();</b>
&nbsp;        //noinspection ConstantConditions
<b class="fc">&nbsp;        Assert.assertTrue(m instanceof Double);</b>
&nbsp;        //noinspection CastCanBeRemovedNarrowingVariableType
<b class="fc">&nbsp;        Assert.assertEquals(Double.NaN, (Double) m, 0D);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;ConstantConditions&quot;)
&nbsp;    @Test
&nbsp;    public void g_V_out_out_max() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;person&quot;).out().out().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Number m = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertTrue(m instanceof Double);</b>
<b class="fc">&nbsp;        Assert.assertEquals(Double.NaN, (Double) m, 0D);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;ConstantConditions&quot;)
&nbsp;    @Test
&nbsp;    public void g_V_repeatXoutX_timesX2X_age_max() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Integer&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V().hasLabel(&quot;person&quot;).repeat(__.out()).times(2).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgMaxGlobalStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Number m = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertTrue(m instanceof Double);</b>
<b class="fc">&nbsp;        Assert.assertEquals(Double.NaN, (Double) m, 0D);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_repeatXbothX_timesX5X_age_max() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Integer&gt; traversal = this.sqlgGraph.traversal().V().repeat(__.both()).times(5).values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        checkResults(Collections.singletonList(35), traversal);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_hasLabelXsoftwareX_group_byXnameX_byXbothE_weight_maxX() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Number&gt;&gt; traversal = this.sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;software&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Number&gt;group().by(&quot;name&quot;).by(</b>
<b class="fc">&nbsp;                        __.bothE().values(&quot;weight&quot;).max()</b>
&nbsp;                );
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        final Map&lt;String, Number&gt; map = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, map.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(1.0, map.get(&quot;ripple&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(0.4, map.get(&quot;lop&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMaxAgain() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Dog&quot;, &quot;age&quot;, 7);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Integer&gt; traversal = this.sqlgGraph.traversal().V().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Integer max = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(7, max, 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMax2() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Integer&gt; traversal = this.sqlgGraph.traversal().V().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        checkResults(Collections.singletonList(35), traversal);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_outXfollowedByX_group_byXsongTypeX_byXbothE_group_byXlabelX_byXweight_sumXX() {
<b class="fc">&nbsp;        loadGratefulDead();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Map&lt;String, Number&gt;&gt;&gt; traversal = this.sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().out(&quot;followedBy&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Map&lt;String, Number&gt;&gt;group()</b>
<b class="fc">&nbsp;                .by(&quot;songType&quot;)</b>
<b class="fc">&nbsp;                .by(</b>
<b class="fc">&nbsp;                        __.bothE()</b>
<b class="fc">&nbsp;                                .group()</b>
<b class="fc">&nbsp;                                .by(T.label)</b>
<b class="fc">&nbsp;                                .by(__.values(&quot;weight&quot;).sum())</b>
&nbsp;                );
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        final Map&lt;String, Map&lt;String, Number&gt;&gt; map = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, map.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(map.containsKey(&quot;&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(map.containsKey(&quot;original&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(map.containsKey(&quot;cover&quot;));</b>
&nbsp;        //
<b class="fc">&nbsp;        Map&lt;String, Number&gt; subMap = map.get(&quot;&quot;);</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, subMap.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(179350, subMap.get(&quot;followedBy&quot;).intValue());</b>
&nbsp;        //
<b class="fc">&nbsp;        subMap = map.get(&quot;original&quot;);</b>
&nbsp;//        Assert.assertEquals(3, subMap.size());
<b class="fc">&nbsp;        Assert.assertEquals(2185613, subMap.get(&quot;followedBy&quot;).intValue());</b>
&nbsp;//        Assert.assertEquals(0, subMap.get(&quot;writtenBy&quot;).intValue());
&nbsp;//        Assert.assertEquals(0, subMap.get(&quot;sungBy&quot;).intValue());
&nbsp;        //
<b class="fc">&nbsp;        subMap = map.get(&quot;cover&quot;);</b>
&nbsp;//        Assert.assertEquals(3, subMap.size());
<b class="fc">&nbsp;        Assert.assertEquals(777982, subMap.get(&quot;followedBy&quot;).intValue());</b>
&nbsp;//        Assert.assertEquals(0, subMap.get(&quot;writtenBy&quot;).intValue());
&nbsp;//        Assert.assertEquals(0, subMap.get(&quot;sungBy&quot;).intValue());
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testSummingNothing() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Traversal&lt;Vertex, Map&lt;String, Integer&gt;&gt; traversal = this.sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().has(&quot;name&quot;, &quot;a5&quot;)</b>
<b class="fc">&nbsp;                .&lt;String, Integer&gt;group().by(T.label).by(__.values(&quot;age&quot;).sum());</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        System.out.println(traversal.next());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCount() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(4, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgCountGlobalStep);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountStartEdge() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).outE().otherV().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).outE().otherV().count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(1, traversal.next(), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountWithJoins() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex b3 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 5);</b>
<b class="fc">&nbsp;        Vertex b4 = this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b3);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).out(&quot;ab&quot;).count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    \t&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(4, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Integer&gt; maxTraversal = this.sqlgGraph.traversal().V().outE().otherV().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        sql = getSQL(maxTraversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(&quot;public&quot;.&quot;V_B&quot;.&quot;age&quot;) AS &quot;alias1&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(5, maxTraversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(maxTraversal.hasNext());</b>
<b class="fc">&nbsp;        traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().outE().otherV().count();</b>
<b class="fc">&nbsp;        sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_ab&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_ab&quot;.&quot;public.A__O&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;V_B&quot; ON &quot;public&quot;.&quot;E_ab&quot;.&quot;public.B__I&quot; = &quot;public&quot;.&quot;V_B&quot;.&quot;ID&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(4, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountMultipleLabels() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b1&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b2&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b3&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;B&quot;, &quot;name&quot;, &quot;b4&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            String sql1 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="fc">&nbsp;            String sql2 = &quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_B&quot;\
&nbsp;                    &quot;&quot;&quot;;
<b class="pc">&nbsp;            if (!sql1.equals(sql) &amp;&amp; !sql2.equals(sql)) {</b>
<b class="nc">&nbsp;                Assert.fail(sql + &quot; not found&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(8, traversal.next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgCountGlobalStep);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountDuplicatePaths() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V(a1).out().out().count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	COUNT(1)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot; INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias2&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a3 ON a2.&quot;public.E_aa.public.A__I&quot; = a3.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.next(), 0);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(3, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgCountGlobalStep);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountWithUnion() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal) this.sqlgGraph.traversal().V()</b>
<b class="fc">&nbsp;                .has(&quot;person&quot;, &quot;name&quot;, &quot;marko&quot;)</b>
<b class="fc">&nbsp;                .has(&quot;name&quot;, &quot;marko&quot;)</b>
<b class="fc">&nbsp;                .count().as(&quot;a&quot;)</b>
<b class="fc">&nbsp;                .union(__.identity(), __.identity())</b>
<b class="fc">&nbsp;                .select(&quot;a&quot;);</b>
<b class="fc">&nbsp;        checkResults(Arrays.asList(1L, 1L), traversal);</b>
<b class="fc">&nbsp;        Assert.assertEquals(5, traversal.getSteps().size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(0) instanceof SqlgGraphStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(1) instanceof SqlgPropertiesStep);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.getSteps().get(2) instanceof SqlgCountGlobalStep);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testCountOnPropertyNotYetExists() {
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;Person&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        DefaultTraversal&lt;Vertex, Long&gt; traversal = (DefaultTraversal&lt;Vertex, Long&gt;) this.sqlgGraph.traversal().V().has(T.label, &quot;Person&quot;).has(&quot;name&quot;, &quot;john&quot;).count();</b>
<b class="fc">&nbsp;        List&lt;Long&gt; count = traversal.toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, count.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(0L, count.get(0), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMaxDuplicatePaths() {
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a1&quot;, &quot;age&quot;, 1);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a2&quot;, &quot;age&quot;, 2);</b>
<b class="fc">&nbsp;        Vertex a3 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a3&quot;, &quot;age&quot;, 3);</b>
<b class="fc">&nbsp;        Vertex a4 = this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;name&quot;, &quot;a4&quot;, &quot;age&quot;, 4);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;aa&quot;, a2);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a3);</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;aa&quot;, a4);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Traversal&lt;Vertex, Integer&gt; traversal = this.sqlgGraph.traversal().V(a1).out().out().values(&quot;age&quot;).max();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    	MAX(a3.&quot;alias3&quot;)\s
&nbsp;                    FROM (SELECT
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    WHERE
&nbsp;                    	( &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = ?)
&nbsp;                    ) a1 INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias1&quot;,
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__I&quot; AS &quot;public.E_aa.public.A__I&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot; INNER JOIN
&nbsp;                    	&quot;public&quot;.&quot;E_aa&quot; ON &quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; = &quot;public&quot;.&quot;E_aa&quot;.&quot;public.A__O&quot;
&nbsp;                    ) a2 ON a1.&quot;public.E_aa.public.A__I&quot; = a2.&quot;alias1&quot; INNER JOIN (SELECT
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;ID&quot; AS &quot;alias2&quot;,
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;.&quot;age&quot; AS &quot;alias3&quot;
&nbsp;                    FROM
&nbsp;                    	&quot;public&quot;.&quot;V_A&quot;
&nbsp;                    ) a3 ON a2.&quot;public.E_aa.public.A__I&quot; = a3.&quot;alias2&quot;\
&nbsp;                    &quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(4, traversal.next(), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testUserSuppliedPKCount() {
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().getPublicSchema()</b>
<b class="fc">&nbsp;                .ensureVertexLabelExist(</b>
&nbsp;                        &quot;Person&quot;,
<b class="fc">&nbsp;                        new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                            put(&quot;uid&quot;, PropertyDefinition.of(PropertyType.varChar(100)));</b>
<b class="fc">&nbsp;                            put(&quot;name&quot;, PropertyDefinition.of(PropertyType.varChar(100)));</b>
&nbsp;                        }},
<b class="fc">&nbsp;                        ListOrderedSet.listOrderedSet(Collections.singletonList(&quot;uid&quot;))</b>
&nbsp;                );
<b class="fc">&nbsp;        Vertex marko = this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;uid&quot;, UUID.randomUUID().toString(), &quot;name&quot;, &quot;marko&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        Vertex john = this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;uid&quot;, UUID.randomUUID().toString());</b>
<b class="fc">&nbsp;        john.property(&quot;name&quot;, &quot;john&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        Traversal&lt;Vertex, Long&gt; traversal = this.sqlgGraph.traversal().V().hasLabel(&quot;Person&quot;).count();</b>
<b class="fc">&nbsp;        String sql = getSQL(traversal);</b>
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&quot;&quot;</b>
&nbsp;                    SELECT
&nbsp;                    \tCOUNT(1) AS &quot;count&quot;
&nbsp;                    FROM
&nbsp;                    \t&quot;public&quot;.&quot;V_Person\&quot;&quot;&quot;&quot;, sql);
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertEquals(2, traversal.next().intValue());</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;marko&quot;, this.sqlgGraph.traversal().V(marko).next().value(&quot;name&quot;));</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;john&quot;, this.sqlgGraph.traversal().V(john).next().value(&quot;name&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This test BaseStrategy skipping optimizing count which comes after a SqlgPropertiesStep
&nbsp;     */
&nbsp;    @Test
&nbsp;    public void testAndColumns() {
<b class="fc">&nbsp;        Vertex v1 = this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name1&quot;, &quot;marko&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertexTraversal(this.sqlgGraph, v1).properties().count().next(), 0);</b>
<b class="fc">&nbsp;        Vertex v2 = this.sqlgGraph.addVertex(T.label, &quot;Person&quot;, &quot;name2&quot;, &quot;john&quot;);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraph.traversal().V().count().next(), 0);</b>
<b class="fc">&nbsp;        Assert.assertEquals(v2, this.sqlgGraph.traversal().V(v2.id()).next());</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertexTraversal(this.sqlgGraph, v2).properties().count().next(), 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void shouldFilterEdgeCriterion() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final Traversal&lt;Edge, ?&gt; edgeCriterion = __.or(</b>
<b class="fc">&nbsp;                __.has(&quot;weight&quot;, 1.0d).hasLabel(&quot;knows&quot;), // 8</b>
<b class="fc">&nbsp;                __.has(&quot;weight&quot;, 0.4d).hasLabel(&quot;created&quot;).outV().has(&quot;name&quot;, &quot;marko&quot;), // 9</b>
<b class="fc">&nbsp;                __.has(&quot;weight&quot;, 1.0d).hasLabel(&quot;created&quot;) // 10</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        GraphTraversalSource g = this.sqlgGraph.traversal();</b>
<b class="fc">&nbsp;        final SubgraphStrategy strategy = SubgraphStrategy.build().edges(edgeCriterion).create();</b>
<b class="fc">&nbsp;        final GraphTraversalSource sg = g.withStrategies(strategy);</b>
&nbsp;
<b class="fc">&nbsp;        Object josh = convertToVertexId(&quot;josh&quot;);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, g.V(josh).both().count().next().longValue());</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, sg.V(josh).both().count().next().longValue());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testMinAgain() {
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Comparable&gt; traversal = this.sqlgGraph.traversal().V().values(&quot;foo&quot;).inject(9999999999L).min();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Assert.assertEquals(9999999999L, traversal.next());</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void g_V_groupXaX_byXnameX_capXaX() {
<b class="fc">&nbsp;        loadModern();</b>
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Collection&lt;Vertex&gt;&gt;&gt; traversal = this.sqlgGraph.traversal().V().group(&quot;a&quot;).by(&quot;name&quot;).cap(&quot;a&quot;);</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        final Map&lt;String, Collection&lt;Vertex&gt;&gt; map = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertEquals(6, map.size());</b>
<b class="fc">&nbsp;        map.forEach((key, values) -&gt; {</b>
<b class="fc">&nbsp;            Assert.assertEquals(1, values.size());</b>
<b class="fc">&nbsp;            Assert.assertEquals(convertToVertexId(key), values.iterator().next().id());</b>
&nbsp;        });
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;//        checkSideEffects(traversal.asAdmin().getSideEffects(), &quot;a&quot;, HashMap.class);
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-23 10:13</div>
</div>
</body>
</html>

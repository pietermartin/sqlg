


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TestForeignSchema</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.umlg.sqlg.test.topology</a>
</div>

<h1>Coverage Summary for Class: TestForeignSchema (org.umlg.sqlg.test.topology)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TestForeignSchema</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (24/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.7%
  </span>
  <span class="absValue">
    (49/105)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    97.7%
  </span>
  <span class="absValue">
    (669/685)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TestForeignSchema$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$10</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$11</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$12</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$13</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$14</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$15</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$16</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$17</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$18</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$19</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$20</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$21</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$22</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$23</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$24</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$25</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$26</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$27</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$28</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$29</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$3</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$30</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$31</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$32</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$33</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$34</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$35</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$36</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$37</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$38</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$5</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$6</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$7</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$8</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TestForeignSchema$9</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (62/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.7%
  </span>
  <span class="absValue">
    (49/105)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    97.9%
  </span>
  <span class="absValue">
    (749/765)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.umlg.sqlg.test.topology;
&nbsp;
&nbsp;import org.apache.commons.collections4.set.ListOrderedSet;
&nbsp;import org.apache.commons.configuration2.builder.fluent.Configurations;
&nbsp;import org.apache.commons.configuration2.ex.ConfigurationException;
&nbsp;import org.apache.commons.lang3.time.StopWatch;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.Order;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.P;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.Scope;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.Traversal;
&nbsp;import org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.__;
&nbsp;import org.apache.tinkerpop.gremlin.structure.Edge;
&nbsp;import org.apache.tinkerpop.gremlin.structure.T;
&nbsp;import org.apache.tinkerpop.gremlin.structure.Transaction;
&nbsp;import org.apache.tinkerpop.gremlin.structure.Vertex;
&nbsp;import org.junit.*;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.umlg.sqlg.structure.PropertyDefinition;
&nbsp;import org.umlg.sqlg.structure.PropertyType;
&nbsp;import org.umlg.sqlg.structure.SqlgGraph;
&nbsp;import org.umlg.sqlg.structure.topology.EdgeLabel;
&nbsp;import org.umlg.sqlg.structure.topology.PropertyColumn;
&nbsp;import org.umlg.sqlg.structure.topology.Schema;
&nbsp;import org.umlg.sqlg.structure.topology.VertexLabel;
&nbsp;import org.umlg.sqlg.test.BaseTest;
&nbsp;import org.umlg.sqlg.util.SqlgUtil;
&nbsp;
&nbsp;import java.net.URL;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.SQLException;
&nbsp;import java.sql.Statement;
&nbsp;import java.util.*;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;import static org.junit.Assert.assertEquals;
&nbsp;import static org.junit.Assert.assertNotNull;
&nbsp;
&nbsp;@SuppressWarnings({&quot;DuplicatedCode&quot;})
<b class="fc">&nbsp;public class TestForeignSchema extends BaseTest {</b>
&nbsp;
<b class="fc">&nbsp;    private final static Logger LOGGER = LoggerFactory.getLogger(TestForeignSchema.class);</b>
&nbsp;    private SqlgGraph sqlgGraphFdw;
&nbsp;
&nbsp;    @BeforeClass
&nbsp;    public static void beforeClass() {
<b class="fc">&nbsp;        URL sqlProperties = Thread.currentThread().getContextClassLoader().getResource(&quot;sqlg.properties&quot;);</b>
&nbsp;        try {
<b class="fc">&nbsp;            Configurations configs = new Configurations();</b>
<b class="fc">&nbsp;            configuration = configs.properties(sqlProperties);</b>
<b class="fc">&nbsp;            Assume.assumeTrue(isPostgres());</b>
<b class="fc">&nbsp;            configuration.addProperty(&quot;distributed&quot;, true);</b>
<b class="pc">&nbsp;            if (!configuration.containsKey(&quot;jdbc.url&quot;))</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(String.format(&quot;SqlGraph configuration requires that the %s be set&quot;, &quot;jdbc.url&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        } catch (ConfigurationException e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @AfterClass
&nbsp;    public static void afterClass() throws SQLException {
<b class="pc">&nbsp;        if (isPostgres()) {</b>
<b class="fc">&nbsp;            URL sqlProperties = Thread.currentThread().getContextClassLoader().getResource(&quot;sqlg.properties&quot;);</b>
&nbsp;            try {
<b class="fc">&nbsp;                Configurations configs = new Configurations();</b>
<b class="fc">&nbsp;                configuration = configs.properties(sqlProperties);</b>
<b class="fc">&nbsp;                SqlgGraph sqlgGraph = SqlgGraph.open(configuration);</b>
<b class="fc">&nbsp;                Connection connection = sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;                try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;                    statement.execute(&quot;DROP SERVER IF EXISTS sqlgraph_fwd_server CASCADE;&quot;);</b>
<b class="pc">&nbsp;                }</b>
<b class="fc">&nbsp;                sqlgGraph.tx().commit();</b>
<b class="nc">&nbsp;            } catch (ConfigurationException e) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Before
&nbsp;    public void before() throws Exception {
<b class="fc">&nbsp;        Assume.assumeTrue(isPostgres());</b>
<b class="fc">&nbsp;        StopWatch stopWatch = new StopWatch();</b>
<b class="fc">&nbsp;        stopWatch.start();</b>
<b class="fc">&nbsp;        this.sqlgGraph = SqlgGraph.open(configuration);</b>
<b class="fc">&nbsp;        SqlgUtil.dropDb(this.sqlgGraph);</b>
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            for (String table : List.of(&quot;V_A&quot;, &quot;V_B&quot;, &quot;E_ab&quot;, &quot;E_ba&quot;,</b>
&nbsp;                    &quot;V_person&quot;, &quot;V_software&quot;, &quot;E_created&quot;, &quot;E_knows&quot;,
&nbsp;                    &quot;V_song&quot;, &quot;V_artist&quot;, &quot;E_followedBy&quot;, &quot;E_writtenBy&quot;, &quot;E_sungBy&quot;)) {
<b class="fc">&nbsp;                String sql = String.format(</b>
&nbsp;                        &quot;DROP FOREIGN TABLE IF EXISTS \&quot;%s\&quot; CASCADE;&quot;,
&nbsp;                        table
&nbsp;                );
<b class="fc">&nbsp;                statement.execute(sql);</b>
&nbsp;            }
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;DROP SCHEMA IF EXISTS \&quot;%s\&quot; CASCADE;&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraph.close();</b>
<b class="fc">&nbsp;        this.sqlgGraph = SqlgGraph.open(configuration);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraphFdw = SqlgGraph.open(&quot;sqlg.fdw.properties&quot;);</b>
<b class="fc">&nbsp;        SqlgUtil.dropDb(this.sqlgGraphFdw);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.close();</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw = SqlgGraph.open(&quot;sqlg.fdw.properties&quot;);</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;        grantReadOnlyUserPrivileges();</b>
<b class="fc">&nbsp;        assertNotNull(this.sqlgGraph);</b>
<b class="fc">&nbsp;        assertNotNull(this.sqlgGraph.getBuildVersion());</b>
<b class="fc">&nbsp;        this.gt = this.sqlgGraph.traversal();</b>
<b class="pc">&nbsp;        if (configuration.getBoolean(&quot;distributed&quot;, false)) {</b>
<b class="fc">&nbsp;            this.sqlgGraph1 = SqlgGraph.open(configuration);</b>
<b class="fc">&nbsp;            assertNotNull(this.sqlgGraph1);</b>
<b class="fc">&nbsp;            assertEquals(this.sqlgGraph.getBuildVersion(), this.sqlgGraph1.getBuildVersion());</b>
&nbsp;        }
<b class="fc">&nbsp;        stopWatch.stop();</b>
<b class="fc">&nbsp;        LOGGER.info(&quot;Startup time for test = &quot; + stopWatch);</b>
<b class="fc">&nbsp;        connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            statement.execute(&quot;CREATE EXTENSION IF NOT EXISTS postgres_fdw;&quot;);</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SERVER \&quot;%s\&quot; FOREIGN DATA WRAPPER postgres_fdw OPTIONS (host &#39;%s&#39;, dbname &#39;%s&#39;, port &#39;%d&#39;);&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;localhost&quot;,
&nbsp;                    &quot;sqlgraphdb_fdw&quot;,
<b class="fc">&nbsp;                    5432</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            this.sqlgGraph.tx().commit();</b>
<b class="pc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            //swallow
&nbsp;//            LOGGER.error(&quot;Failed to create &#39;sqlgraph_fwd_server&#39;&quot;, e);
&nbsp;        } finally {
<b class="fc">&nbsp;            this.sqlgGraph.tx().rollback();</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        connection = sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE USER MAPPING FOR %s SERVER \&quot;%s\&quot; OPTIONS (user &#39;%s&#39;, password &#39;%s&#39;);&quot;,
&nbsp;                    &quot;postgres&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;postgres&quot;,
&nbsp;                    &quot;postgres&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            this.sqlgGraph.tx().commit();</b>
<b class="pc">&nbsp;        } catch (SQLException throwables) {</b>
&nbsp;            //swallow for mostly the server will already exist
&nbsp;        } finally {
<b class="fc">&nbsp;            this.sqlgGraph.tx().rollback();</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @After
&nbsp;    public void after() {
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.tx().onClose(Transaction.CLOSE_BEHAVIOR.ROLLBACK);</b>
<b class="fc">&nbsp;            this.sqlgGraph.close();</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            LOGGER.error(e.getMessage(), e);</b>
&nbsp;        }
&nbsp;        try {
<b class="pc">&nbsp;            if (this.sqlgGraph1 != null) {</b>
<b class="fc">&nbsp;                this.sqlgGraph1.tx().onClose(Transaction.CLOSE_BEHAVIOR.ROLLBACK);</b>
<b class="fc">&nbsp;                this.sqlgGraph1.close();</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            LOGGER.error(e.getMessage(), e);</b>
&nbsp;        }
&nbsp;        try {
<b class="pc">&nbsp;            if (this.sqlgGraphFdw != null) {</b>
<b class="fc">&nbsp;                this.sqlgGraphFdw.tx().onClose(Transaction.CLOSE_BEHAVIOR.ROLLBACK);</b>
<b class="fc">&nbsp;                this.sqlgGraphFdw.close();</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            LOGGER.error(e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaVertexLabels() throws SQLException {
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Schema b = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;B&quot;);</b>
&nbsp;        @SuppressWarnings(&quot;UnusedAssignment&quot;)
<b class="fc">&nbsp;        VertexLabel bVertexLabel = b.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;b&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(this.sqlgGraphFdw.getTopology().getSchema(&quot;B&quot;).orElseThrow()));</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;B&quot;).isPresent());</b>
&nbsp;
&nbsp;        //Check its readOnly
<b class="fc">&nbsp;        Schema foreignSchema = this.sqlgGraph.getTopology().getSchema(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        boolean failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            foreignSchema.ensureVertexLabelExist(&quot;D&quot;,</b>
<b class="fc">&nbsp;                    new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                        put(&quot;d&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                    }});
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;B&#39; is a read only foreign schema!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            bVertexLabel = foreignSchema.getVertexLabel(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;            Map&lt;String, PropertyColumn&gt; properties = bVertexLabel.getProperties();</b>
<b class="fc">&nbsp;            Map&lt;String, PropertyDefinition&gt; propertyDefinitionMap = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            for (String p : properties.keySet()) {</b>
<b class="fc">&nbsp;                propertyDefinitionMap.put(p, properties.get(p).getPropertyDefinition());</b>
&nbsp;            }
<b class="fc">&nbsp;            propertyDefinitionMap.put(&quot;bb&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
<b class="fc">&nbsp;            bVertexLabel.ensurePropertiesExist(propertyDefinitionMap);</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;B&#39; is a read only foreign VertexLabel!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraphFdw.addVertex(T.label, &quot;B.B&quot;, &quot;b&quot;, &quot;halo&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;a&quot;, &quot;test&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; aVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, aVertices.size());</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().getPublicSchema().ensureVertexLabelExist(&quot;C&quot;, new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;c&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
&nbsp;        //Assert that one can not insert into a foreign table with sequence primary key.
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.addVertex(T.label, &quot;B.B&quot;, &quot;b&quot;, &quot;halo again&quot;);</b>
<b class="fc">&nbsp;        } catch (IllegalStateException e) {</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaVertexAndEdgeLabels() throws SQLException {
<b class="fc">&nbsp;        Schema aSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A.A&quot;, &quot;a&quot;, &quot;haloA&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;A.B&quot;, &quot;a&quot;, &quot;haloB&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Schema a1 = this.sqlgGraphFdw.getTopology().getSchema(&quot;A&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel ab = a1.getEdgeLabel(&quot;ab&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(a1));</b>
<b class="fc">&nbsp;        EdgeLabel ab_after =  a1.getEdgeLabel(&quot;ab&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel_after = a1.getVertexLabel(&quot;A&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel bVertexLabel_after = a1.getVertexLabel(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        Assert.assertSame(ab, ab_after);</b>
<b class="fc">&nbsp;        Assert.assertSame(aVertexLabel, aVertexLabel_after);</b>
<b class="fc">&nbsp;        Assert.assertSame(bVertexLabel, bVertexLabel_after);</b>
&nbsp;
<b class="fc">&nbsp;        Optional&lt;Schema&gt; schemaOptional = this.sqlgGraph.getTopology().getSchema(&quot;A&quot;);</b>
<b class="fc">&nbsp;        Assert.assertTrue(schemaOptional.isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(schemaOptional.get().isForeignSchema());</b>
<b class="fc">&nbsp;        Schema aForeignSchema = schemaOptional.get();</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getVertexLabel(&quot;A&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getVertexLabel(&quot;A&quot;).get().isForeign());</b>
<b class="fc">&nbsp;        VertexLabel aForeignVertexLabel = aForeignSchema.getVertexLabel(&quot;A&quot;).get();</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getVertexLabel(&quot;B&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getVertexLabel(&quot;B&quot;).get().isForeign());</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getEdgeLabel(&quot;ab&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(aForeignSchema.getEdgeLabel(&quot;ab&quot;).get().isForeign());</b>
&nbsp;
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.B&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;haloB&quot;, vertices.get(0).value(&quot;a&quot;));</b>
&nbsp;
&nbsp;        //This is important, postgres_fdw runs fetch queries which will dead lock on alter statements.
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
&nbsp;
&nbsp;        //Check its readOnly
<b class="fc">&nbsp;        boolean failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            aForeignSchema.ensureVertexLabelExist(&quot;C&quot;, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;            }});
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;A&#39; is a read only foreign schema!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;
&nbsp;        //Add another VertexLabel
<b class="fc">&nbsp;        VertexLabel cVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;C&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ac&quot;, cVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
&nbsp;        //Check its readOnly
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            aForeignVertexLabel.ensureEdgeLabelExist(&quot;bc&quot;, cVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;            }});
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;A&#39; is a read only foreign schema!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;
&nbsp;        //Check can not insert vertex via foreign label
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.addVertex(T.label, &quot;A.A&quot;, &quot;a&quot;, &quot;haloAgain&quot;);</b>
<b class="fc">&nbsp;        } catch (IllegalStateException e) {</b>
<b class="fc">&nbsp;            failed = true;</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;Foreign VertexLabel must have user defined identifiers to support addition.&quot;, e.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
&nbsp;
&nbsp;        //Check can not insert edge via foreign label
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).toList();</b>
<b class="fc">&nbsp;            Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;            a = vertices.get(0);</b>
<b class="fc">&nbsp;            vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.B&quot;).toList();</b>
<b class="fc">&nbsp;            Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;            b = vertices.get(0);</b>
<b class="fc">&nbsp;            a.addEdge(&quot;ab&quot;, b);</b>
<b class="nc">&nbsp;            this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        } catch (IllegalStateException e) {</b>
<b class="fc">&nbsp;            failed = true;</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;Foreign EdgeLabel must have user defined identifiers to support addition.&quot;, e.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testVertexLabelWithSameNameInDifferentSchemas() {
<b class="fc">&nbsp;        Schema real = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;REAL&quot;);</b>
<b class="fc">&nbsp;        VertexLabel realPerson = real.ensureVertexLabelExist(&quot;Person&quot;);</b>
<b class="fc">&nbsp;        VertexLabel realSoftware = real.ensureVertexLabelExist(&quot;Software&quot;);</b>
<b class="fc">&nbsp;        realPerson.ensureEdgeLabelExist(&quot;created&quot;, realSoftware);</b>
<b class="fc">&nbsp;        Schema plan = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;PLAN&quot;);</b>
<b class="fc">&nbsp;        VertexLabel planPerson = plan.ensureVertexLabelExist(&quot;Person&quot;);</b>
<b class="fc">&nbsp;        VertexLabel planSoftware = plan.ensureVertexLabelExist(&quot;Software&quot;);</b>
<b class="fc">&nbsp;        planPerson.ensureEdgeLabelExist(&quot;created&quot;, planSoftware);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(real, plan));</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, VertexLabel&gt; vertexLabelMap = real.getVertexLabels();</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelMap.containsKey(&quot;REAL.V_Person&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelMap.containsKey(&quot;REAL.V_Software&quot;));</b>
<b class="fc">&nbsp;        VertexLabel vertexLabel = vertexLabelMap.get(&quot;REAL.V_Person&quot;);</b>
<b class="fc">&nbsp;        Map&lt;String, EdgeLabel&gt; edgeLabelMap = vertexLabel.getInEdgeLabels();</b>
<b class="fc">&nbsp;        Assert.assertEquals(0, edgeLabelMap.size());</b>
<b class="fc">&nbsp;        vertexLabel = vertexLabelMap.get(&quot;REAL.V_Software&quot;);</b>
<b class="fc">&nbsp;        edgeLabelMap = vertexLabel.getInEdgeLabels();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, edgeLabelMap.size());</b>
&nbsp;
<b class="fc">&nbsp;        Schema foreignReal = this.sqlgGraph.getTopology().getSchema(&quot;REAL&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        vertexLabelMap = foreignReal.getVertexLabels();</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelMap.containsKey(&quot;REAL.V_Person&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelMap.containsKey(&quot;REAL.V_Software&quot;));</b>
<b class="fc">&nbsp;        vertexLabel = vertexLabelMap.get(&quot;REAL.V_Person&quot;);</b>
<b class="fc">&nbsp;        edgeLabelMap = vertexLabel.getInEdgeLabels();</b>
<b class="fc">&nbsp;        Assert.assertEquals(0, edgeLabelMap.size());</b>
<b class="fc">&nbsp;        vertexLabel = vertexLabelMap.get(&quot;REAL.V_Software&quot;);</b>
<b class="fc">&nbsp;        edgeLabelMap = vertexLabel.getInEdgeLabels();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, edgeLabelMap.size());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testReimportForeignSchema() {
<b class="fc">&nbsp;        Schema aSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(aSchema));</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().clearForeignSchemas();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(aSchema));</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;A&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;A&quot;).orElseThrow().getVertexLabel(&quot;A&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;A&quot;).orElseThrow().getVertexLabel(&quot;B&quot;).isPresent());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaEdgeLabelAcrossSchemaInVertexLabelFailure1() throws SQLException {
<b class="fc">&nbsp;        Schema aSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        Schema bSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;B&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = bSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A.A&quot;, &quot;a&quot;, &quot;haloA&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;B.B&quot;, &quot;a&quot;, &quot;haloB&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        boolean failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.getTopology().importForeignSchemas(Set.of(this.sqlgGraphFdw.getTopology().getSchema(&quot;A&quot;).orElseThrow()));</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            failed = true;</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;EdgeLabel &#39;A.E_ab&#39; has a inVertexLabel &#39;B&#39; that is not present in a foreign schema&quot;, e.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaEdgeLabelAcrossSchemaOutVertexLabelFailure1() throws SQLException {
<b class="fc">&nbsp;        Schema aSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        Schema bSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;B&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = bSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A.A&quot;, &quot;a&quot;, &quot;haloA&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;B.B&quot;, &quot;a&quot;, &quot;haloB&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        boolean failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.getTopology().importForeignSchemas(Set.of(this.sqlgGraphFdw.getTopology().getSchema(&quot;B&quot;).orElseThrow()));</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            failed = true;</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;VertexLabel &#39;B.V_B&#39; has an inEdgeLabel &#39;ab&#39; that is not present in a foreign schema&quot;, e.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaEdgeLabelAcrossSchemaOutVertexLabelSuccess() throws SQLException {
<b class="fc">&nbsp;        Schema aSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        Schema bSchema = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;B&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = aSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = bSchema.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A.A&quot;, &quot;a&quot;, &quot;haloA&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;B.B&quot;, &quot;a&quot;, &quot;haloB&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraphFdw.traversal().V().hasLabel(&quot;B.B&quot;).in(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraphFdw.traversal().E().hasLabel(&quot;ab&quot;).inV().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;B.B&quot;, vertices.get(0).label());</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(</b>
<b class="fc">&nbsp;                this.sqlgGraphFdw.getTopology().getSchema(&quot;A&quot;).orElseThrow(),</b>
<b class="fc">&nbsp;                this.sqlgGraphFdw.getTopology().getSchema(&quot;B&quot;).orElseThrow()</b>
&nbsp;        ));
&nbsp;
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).out().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).out(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).in(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        List&lt;Edge&gt; edges = this.sqlgGraph.traversal().E().hasLabel(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, edges.size());</b>
<b class="fc">&nbsp;        vertices = this.sqlgGraph.traversal().E().hasLabel(&quot;ab&quot;).inV().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
<b class="fc">&nbsp;        Assert.assertEquals(&quot;B.B&quot;, vertices.get(0).label());</b>
<b class="fc">&nbsp;        edges = this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).outE().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, edges.size());</b>
<b class="fc">&nbsp;        edges = this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).outE().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(0, edges.size());</b>
<b class="fc">&nbsp;        edges = this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).inE().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, edges.size());</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().clearForeignSchemas();</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;A&quot;).isEmpty());</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;B&quot;).isEmpty());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaVertexAndEdgeLabelInPublic() throws SQLException {
<b class="fc">&nbsp;        VertexLabel aVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
&nbsp;        @SuppressWarnings(&quot;unused&quot;)
<b class="fc">&nbsp;        EdgeLabel edgeLabel = aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A&quot;, &quot;a&quot;, &quot;halo A&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;B&quot;, &quot;a&quot;, &quot;halo B&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab edge&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; LIMIT TO (%s) FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema(),</b>
&nbsp;                    &quot;\&quot;V_A\&quot;,\&quot;V_B\&quot;,\&quot;E_ab\&quot;&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema()</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        VertexLabel foreignAVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;A&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel foreignBVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel foreignABEdgeLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;ab&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignVertexEdgeLabels(</b>
<b class="fc">&nbsp;                this.sqlgGraph.getTopology().getPublicSchema(),</b>
<b class="fc">&nbsp;                Set.of(foreignAVertexLabel, foreignBVertexLabel),</b>
<b class="fc">&nbsp;                Set.of(foreignABEdgeLabel)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;A&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;B&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getPublicSchema().getEdgeLabel(&quot;ab&quot;).isPresent());</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Vertex&gt; aVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, aVertices.size());</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; bVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;B&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, bVertices.size());</b>
<b class="fc">&nbsp;        List&lt;Edge&gt; abEdges = this.sqlgGraph.traversal().E().hasLabel(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, abEdges.size());</b>
<b class="fc">&nbsp;        bVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).out().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, bVertices.size());</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().clearForeignSchemas();</b>
<b class="fc">&nbsp;        Assert.assertFalse(this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;A&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertFalse(this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;B&quot;).isPresent());</b>
<b class="fc">&nbsp;        Assert.assertFalse(this.sqlgGraph.getTopology().getPublicSchema().getEdgeLabel(&quot;ab&quot;).isPresent());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testImportForeignSchemaVertexAndEdgeLabelInPublicFailure() throws SQLException {
<b class="fc">&nbsp;        VertexLabel aVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
&nbsp;        @SuppressWarnings(&quot;unused&quot;)
<b class="fc">&nbsp;        EdgeLabel edgeLabel = aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
&nbsp;        @SuppressWarnings(&quot;unused&quot;)
<b class="fc">&nbsp;        EdgeLabel baEdgeLabel = bVertexLabel.ensureEdgeLabelExist(&quot;ba&quot;, aVertexLabel, new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        Vertex a = this.sqlgGraphFdw.addVertex(T.label, &quot;A&quot;, &quot;a&quot;, &quot;halo A&quot;);</b>
<b class="fc">&nbsp;        Vertex b = this.sqlgGraphFdw.addVertex(T.label, &quot;B&quot;, &quot;a&quot;, &quot;halo B&quot;);</b>
<b class="fc">&nbsp;        a.addEdge(&quot;ab&quot;, b, &quot;a&quot;, &quot;halo ab edge&quot;);</b>
<b class="fc">&nbsp;        b.addEdge(&quot;ba&quot;, a, &quot;a&quot;, &quot;halo ba edge&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; LIMIT TO (%s) FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema(),</b>
&nbsp;                    &quot;\&quot;V_A\&quot;,\&quot;V_B\&quot;,\&quot;E_ab\&quot;,\&quot;E_ba\&quot;&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema()</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        VertexLabel foreignAVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;A&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel foreignBVertexLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel foreignABEdgeLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;ab&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel foreignBAEdgeLabel = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;ba&quot;).orElseThrow();</b>
&nbsp;
<b class="fc">&nbsp;        boolean failure = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.getTopology().importForeignVertexEdgeLabels(</b>
<b class="fc">&nbsp;                    this.sqlgGraph.getTopology().getPublicSchema(),</b>
<b class="fc">&nbsp;                    Set.of(foreignAVertexLabel, foreignBVertexLabel),</b>
<b class="fc">&nbsp;                    Set.of(foreignABEdgeLabel)</b>
&nbsp;            );
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            failure = true;</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;public.E_public.ba&#39; is not present in the foreign EdgeLabels&quot;, e.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failure);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignVertexEdgeLabels(</b>
<b class="fc">&nbsp;                this.sqlgGraph.getTopology().getPublicSchema(),</b>
<b class="fc">&nbsp;                Set.of(foreignAVertexLabel, foreignBVertexLabel),</b>
<b class="fc">&nbsp;                Set.of(foreignABEdgeLabel, foreignBAEdgeLabel)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        Optional&lt;VertexLabel&gt; vertexLabelOptional = this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;A&quot;);</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelOptional.isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelOptional.get().isForeign());</b>
&nbsp;
<b class="fc">&nbsp;        vertexLabelOptional = this.sqlgGraph.getTopology().getPublicSchema().getVertexLabel(&quot;B&quot;);</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelOptional.isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(vertexLabelOptional.get().isForeign());</b>
&nbsp;
<b class="fc">&nbsp;        Optional&lt;EdgeLabel&gt; edgeLabelOptional = this.sqlgGraph.getTopology().getPublicSchema().getEdgeLabel(&quot;ab&quot;);</b>
<b class="fc">&nbsp;        Assert.assertTrue(edgeLabelOptional.isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(edgeLabelOptional.get().isForeign());</b>
&nbsp;
<b class="fc">&nbsp;        edgeLabelOptional = this.sqlgGraph.getTopology().getPublicSchema().getEdgeLabel(&quot;ba&quot;);</b>
<b class="fc">&nbsp;        Assert.assertTrue(edgeLabelOptional.isPresent());</b>
<b class="fc">&nbsp;        Assert.assertTrue(edgeLabelOptional.get().isForeign());</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Vertex&gt; aVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, aVertices.size());</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; bVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;B&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, bVertices.size());</b>
<b class="fc">&nbsp;        List&lt;Edge&gt; abEdges = this.sqlgGraph.traversal().E().hasLabel(&quot;ab&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, abEdges.size());</b>
<b class="fc">&nbsp;        List&lt;Edge&gt; baEdges = this.sqlgGraph.traversal().E().hasLabel(&quot;ba&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, baEdges.size());</b>
<b class="fc">&nbsp;        bVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).out().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, bVertices.size());</b>
<b class="fc">&nbsp;        bVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).in().toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, bVertices.size());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void importTinkerPopClassic() throws SQLException {
<b class="fc">&nbsp;        loadModern(this.sqlgGraphFdw);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        VertexLabel person = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;person&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel software = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;software&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel created = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;created&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel knows = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;knows&quot;).orElseThrow();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; LIMIT TO (%s) FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema(),</b>
&nbsp;                    &quot;\&quot;V_person\&quot;,\&quot;V_software\&quot;,\&quot;E_created\&quot;,\&quot;E_knows\&quot;&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema()</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignVertexEdgeLabels(</b>
<b class="fc">&nbsp;                this.sqlgGraph.getTopology().getPublicSchema(),</b>
<b class="fc">&nbsp;                Set.of(person, software),</b>
<b class="fc">&nbsp;                Set.of(created, knows)</b>
&nbsp;        );
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, Map&lt;String, Map&lt;String, Object&gt;&gt;&gt;&gt; traversal = this.sqlgGraph.traversal()</b>
<b class="fc">&nbsp;                .V().hasLabel(&quot;person&quot;)</b>
<b class="fc">&nbsp;                .filter(__.outE(&quot;created&quot;)).aggregate(&quot;p&quot;).as(&quot;p1&quot;).values(&quot;name&quot;).as(&quot;p1n&quot;)</b>
<b class="fc">&nbsp;                .select(&quot;p&quot;).unfold().where(P.neq(&quot;p1&quot;)).as(&quot;p2&quot;).values(&quot;name&quot;).as(&quot;p2n&quot;).select(&quot;p2&quot;)</b>
<b class="fc">&nbsp;                .out(&quot;created&quot;).choose(__.in(&quot;created&quot;).where(P.eq(&quot;p1&quot;)), __.values(&quot;name&quot;), __.constant(Collections.emptyList()))</b>
<b class="fc">&nbsp;                .&lt;String, Map&lt;String, Map&lt;String, Object&gt;&gt;&gt;group().by(__.select(&quot;p1n&quot;)).</b>
<b class="fc">&nbsp;                by(__.group().by(__.select(&quot;p2n&quot;)).</b>
<b class="fc">&nbsp;                        by(__.unfold().fold().project(&quot;numCoCreated&quot;, &quot;coCreated&quot;).by(__.count(Scope.local)).by()));</b>
<b class="fc">&nbsp;        this.printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        checkCoworkerSummary(traversal.next());</b>
<b class="fc">&nbsp;        Assert.assertFalse(traversal.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void checkCoworkerSummary(final Map&lt;String, Map&lt;String, Map&lt;String, Object&gt;&gt;&gt; summary) {
<b class="fc">&nbsp;        Assert.assertNotNull(summary);</b>
<b class="fc">&nbsp;        Assert.assertEquals(3, summary.size());</b>
<b class="fc">&nbsp;        Assert.assertTrue(summary.containsKey(&quot;marko&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(summary.containsKey(&quot;josh&quot;));</b>
<b class="fc">&nbsp;        Assert.assertTrue(summary.containsKey(&quot;peter&quot;));</b>
<b class="fc">&nbsp;        for (final Map.Entry&lt;String, Map&lt;String, Map&lt;String, Object&gt;&gt;&gt; entry : summary.entrySet()) {</b>
<b class="fc">&nbsp;            assertEquals(2, entry.getValue().size());</b>
<b class="pc">&nbsp;            switch (entry.getKey()) {</b>
&nbsp;                case &quot;marko&quot;:
<b class="pc">&nbsp;                    Assert.assertTrue(entry.getValue().containsKey(&quot;josh&quot;) &amp;&amp; entry.getValue().containsKey(&quot;peter&quot;));</b>
&nbsp;                    break;
&nbsp;                case &quot;josh&quot;:
<b class="pc">&nbsp;                    Assert.assertTrue(entry.getValue().containsKey(&quot;peter&quot;) &amp;&amp; entry.getValue().containsKey(&quot;marko&quot;));</b>
&nbsp;                    break;
&nbsp;                case &quot;peter&quot;:
<b class="pc">&nbsp;                    Assert.assertTrue(entry.getValue().containsKey(&quot;marko&quot;) &amp;&amp; entry.getValue().containsKey(&quot;josh&quot;));</b>
&nbsp;                    break;
&nbsp;            }
<b class="fc">&nbsp;            for (final Map&lt;String, Object&gt; m : entry.getValue().values()) {</b>
<b class="fc">&nbsp;                Assert.assertTrue(m.containsKey(&quot;numCoCreated&quot;));</b>
<b class="fc">&nbsp;                Assert.assertTrue(m.containsKey(&quot;coCreated&quot;));</b>
<b class="fc">&nbsp;                Assert.assertTrue(m.get(&quot;numCoCreated&quot;) instanceof Number);</b>
<b class="fc">&nbsp;                Assert.assertTrue(m.get(&quot;coCreated&quot;) instanceof Collection);</b>
<b class="fc">&nbsp;                Assert.assertEquals(1, ((Number) m.get(&quot;numCoCreated&quot;)).intValue());</b>
<b class="fc">&nbsp;                Assert.assertEquals(1, ((Collection) m.get(&quot;coCreated&quot;)).size());</b>
<b class="fc">&nbsp;                Assert.assertEquals(&quot;lop&quot;, ((Collection) m.get(&quot;coCreated&quot;)).iterator().next());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void importTinkerPopGratefulDead() throws SQLException {
<b class="fc">&nbsp;        loadGratefulDead(this.sqlgGraphFdw);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        VertexLabel song = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;song&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        VertexLabel artist = this.sqlgGraphFdw.getTopology().getPublicSchema().getVertexLabel(&quot;artist&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel followedBy = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;followedBy&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel writtenBy = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;writtenBy&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        EdgeLabel sungBy = this.sqlgGraphFdw.getTopology().getPublicSchema().getEdgeLabel(&quot;sungBy&quot;).orElseThrow();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; LIMIT TO (%s) FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema(),</b>
&nbsp;                    &quot;\&quot;V_song\&quot;,\&quot;V_artist\&quot;,\&quot;E_followedBy\&quot;,\&quot;E_writtenBy\&quot;, \&quot;E_sungBy\&quot;&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema()</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignVertexEdgeLabels(</b>
<b class="fc">&nbsp;                this.sqlgGraph.getTopology().getPublicSchema(),</b>
<b class="fc">&nbsp;                Set.of(song, artist),</b>
<b class="fc">&nbsp;                Set.of(followedBy, writtenBy, sungBy)</b>
&nbsp;        );
<b class="fc">&nbsp;        final Traversal&lt;Vertex, Map&lt;String, List&lt;String&gt;&gt;&gt; traversal = getPlaylistPaths();</b>
<b class="fc">&nbsp;        printTraversalForm(traversal);</b>
<b class="fc">&nbsp;        Assert.assertTrue(traversal.hasNext());</b>
<b class="fc">&nbsp;        Map&lt;String, List&lt;String&gt;&gt; map = traversal.next();</b>
<b class="fc">&nbsp;        Assert.assertTrue(map.get(&quot;artists&quot;).contains(&quot;Bob_Dylan&quot;));</b>
<b class="fc">&nbsp;        boolean hasJohnnyCash = false;</b>
<b class="fc">&nbsp;        while (traversal.hasNext()) {</b>
<b class="fc">&nbsp;            map = traversal.next();</b>
<b class="fc">&nbsp;            if (map.get(&quot;artists&quot;).contains(&quot;Johnny_Cash&quot;))</b>
<b class="fc">&nbsp;                hasJohnnyCash = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(hasJohnnyCash);</b>
<b class="fc">&nbsp;        Assert.assertTrue(map.get(&quot;artists&quot;).contains(&quot;Grateful_Dead&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;    private Traversal&lt;Vertex, Map&lt;String, List&lt;String&gt;&gt;&gt; getPlaylistPaths() {
<b class="fc">&nbsp;        return this.sqlgGraph.traversal().V().has(&quot;name&quot;, &quot;Bob_Dylan&quot;).in(&quot;sungBy&quot;).as(&quot;a&quot;).</b>
<b class="fc">&nbsp;                repeat(__.out().order().by(Order.shuffle).simplePath().from(&quot;a&quot;)).</b>
<b class="fc">&nbsp;                until(__.out(&quot;writtenBy&quot;).has(&quot;name&quot;, &quot;Johnny_Cash&quot;)).limit(1).as(&quot;b&quot;).</b>
<b class="fc">&nbsp;                repeat(__.out().order().by(Order.shuffle).as(&quot;c&quot;).simplePath().from(&quot;b&quot;).to(&quot;c&quot;)).</b>
<b class="fc">&nbsp;                until(__.out(&quot;sungBy&quot;).has(&quot;name&quot;, &quot;Grateful_Dead&quot;)).limit(1).</b>
<b class="fc">&nbsp;                path().from(&quot;a&quot;).unfold().</b>
<b class="fc">&nbsp;                        &lt;List&lt;String&gt;&gt;project(&quot;song&quot;, &quot;artists&quot;).</b>
<b class="fc">&nbsp;                by(&quot;name&quot;).</b>
<b class="fc">&nbsp;                by(__.coalesce(__.out(&quot;sungBy&quot;, &quot;writtenBy&quot;).dedup().values(&quot;name&quot;), __.constant(&quot;Unknown&quot;)).fold());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testQueryViaFDW_WhileInsertingDirectly() throws SQLException, InterruptedException {
<b class="fc">&nbsp;        this.sqlgGraphFdw.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }}
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; LIMIT TO (%s) FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema(),</b>
&nbsp;                    &quot;\&quot;V_A\&quot;&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
<b class="fc">&nbsp;                    this.sqlgGraph.getSqlDialect().getPublicSchema()</b>
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        ExecutorService executorService1 = Executors.newFixedThreadPool(1);</b>
<b class="fc">&nbsp;        executorService1.submit(() -&gt; {</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; 10_000; i++) {</b>
<b class="fc">&nbsp;                this.sqlgGraphFdw.addVertex(T.label, &quot;A&quot;, &quot;a&quot;, &quot;halo A&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;            LOGGER.info(&quot;Completed executorService1&quot;);</b>
&nbsp;        });
<b class="fc">&nbsp;        ExecutorService executorService2 = Executors.newFixedThreadPool(1);</b>
<b class="fc">&nbsp;        executorService2.submit(() -&gt; {</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; 10_000; i++) {</b>
<b class="fc">&nbsp;                List&lt;Vertex&gt; vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).toList();</b>
<b class="fc">&nbsp;                Assert.assertEquals(0, vertices.size());</b>
&nbsp;            }
<b class="fc">&nbsp;            this.sqlgGraphFdw.tx().rollback();</b>
<b class="fc">&nbsp;            LOGGER.info(&quot;Completed executorService2&quot;);</b>
&nbsp;        });
<b class="fc">&nbsp;        executorService1.shutdown();</b>
<b class="pc">&nbsp;        if (!executorService1.awaitTermination(1, TimeUnit.MINUTES)) {</b>
<b class="nc">&nbsp;            Assert.fail(&quot;ExecutorService did not shutdown in 1 minute&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        executorService2.shutdown();</b>
<b class="pc">&nbsp;        if (!executorService2.awaitTermination(1, TimeUnit.MINUTES)) {</b>
<b class="nc">&nbsp;            Assert.fail(&quot;ExecutorService did not shutdown in 1 minute&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        LOGGER.debug(&quot;Done&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testInsertViaForeignSchema() throws SQLException {
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().getPublicSchema().ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;uuid&quot;, PropertyDefinition.of(PropertyType.UUID));</b>
<b class="fc">&nbsp;                    put(&quot;a&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }},
<b class="fc">&nbsp;                ListOrderedSet.listOrderedSet(Set.of(&quot;uuid&quot;))</b>
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Schema b = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;B&quot;);</b>
&nbsp;        @SuppressWarnings(&quot;UnusedAssignment&quot;)
<b class="fc">&nbsp;        VertexLabel bVertexLabel = b.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;uuid&quot;, PropertyDefinition.of(PropertyType.UUID));</b>
<b class="fc">&nbsp;                    put(&quot;b&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }},
<b class="fc">&nbsp;                ListOrderedSet.listOrderedSet(Set.of(&quot;uuid&quot;))</b>
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;B&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;B&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(this.sqlgGraphFdw.getTopology().getSchema(&quot;B&quot;).orElseThrow()));</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;B&quot;).isPresent());</b>
&nbsp;
&nbsp;        //Check its readOnly
<b class="fc">&nbsp;        Schema foreignSchema = this.sqlgGraph.getTopology().getSchema(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;        boolean failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            foreignSchema.ensureVertexLabelExist(&quot;D&quot;,</b>
<b class="fc">&nbsp;                    new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                        put(&quot;d&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                    }});
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;B&#39; is a read only foreign schema!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            bVertexLabel = foreignSchema.getVertexLabel(&quot;B&quot;).orElseThrow();</b>
<b class="fc">&nbsp;            Map&lt;String, PropertyColumn&gt; properties = bVertexLabel.getProperties();</b>
<b class="fc">&nbsp;            Map&lt;String, PropertyDefinition&gt; propertyDefinitionMap = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;            for (String p : properties.keySet()) {</b>
<b class="fc">&nbsp;                propertyDefinitionMap.put(p, properties.get(p).getPropertyDefinition());</b>
&nbsp;            }
<b class="fc">&nbsp;            propertyDefinitionMap.put(&quot;bb&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
<b class="fc">&nbsp;            bVertexLabel.ensurePropertiesExist(propertyDefinitionMap);</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            Assert.assertTrue(e instanceof IllegalStateException);</b>
<b class="fc">&nbsp;            Assert.assertEquals(&quot;&#39;B&#39; is a read only foreign VertexLabel!&quot;, e.getMessage());</b>
<b class="fc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertTrue(failed);</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraphFdw.addVertex(T.label, &quot;B.B&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;b&quot;, &quot;halo&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; vertices = this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, vertices.size());</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.addVertex(T.label, &quot;A&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;a&quot;, &quot;test&quot;);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        List&lt;Vertex&gt; aVertices = this.sqlgGraph.traversal().V().hasLabel(&quot;A&quot;).toList();</b>
<b class="fc">&nbsp;        Assert.assertEquals(1, aVertices.size());</b>
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().getPublicSchema().ensureVertexLabelExist(&quot;C&quot;, new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;            put(&quot;c&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;        }});
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
&nbsp;        //Assert that one can not insert into a foreign table with sequence primary key.
<b class="fc">&nbsp;        failed = false;</b>
&nbsp;        try {
<b class="fc">&nbsp;            this.sqlgGraph.addVertex(T.label, &quot;B.B&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;b&quot;, &quot;halo again&quot;);</b>
<b class="nc">&nbsp;        } catch (IllegalStateException e) {</b>
<b class="nc">&nbsp;            failed = true;</b>
&nbsp;        }
<b class="fc">&nbsp;        Assert.assertFalse(failed);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V().hasLabel(&quot;B.B&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraph.traversal().V().hasLabel(&quot;B.B&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Test
&nbsp;    public void testInsertEdgesViaForeignSchema() throws SQLException {
<b class="fc">&nbsp;        Schema a = this.sqlgGraphFdw.getTopology().ensureSchemaExist(&quot;A&quot;);</b>
<b class="fc">&nbsp;        VertexLabel aVertexLabel = a.ensureVertexLabelExist(</b>
&nbsp;                &quot;A&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;uuid&quot;, PropertyDefinition.of(PropertyType.UUID));</b>
<b class="fc">&nbsp;                    put(&quot;name&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }},
<b class="fc">&nbsp;                ListOrderedSet.listOrderedSet(Set.of(&quot;uuid&quot;))</b>
&nbsp;        );
<b class="fc">&nbsp;        VertexLabel bVertexLabel = a.ensureVertexLabelExist(</b>
&nbsp;                &quot;B&quot;,
<b class="fc">&nbsp;                new LinkedHashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;uuid&quot;, PropertyDefinition.of(PropertyType.UUID));</b>
<b class="fc">&nbsp;                    put(&quot;name&quot;, PropertyDefinition.of(PropertyType.STRING));</b>
&nbsp;                }},
<b class="fc">&nbsp;                ListOrderedSet.listOrderedSet(Set.of(&quot;uuid&quot;))</b>
&nbsp;        );
<b class="fc">&nbsp;        aVertexLabel.ensureEdgeLabelExist(&quot;ab&quot;, bVertexLabel,</b>
<b class="fc">&nbsp;                new HashMap&lt;&gt;() {{</b>
<b class="fc">&nbsp;                    put(&quot;uuid&quot;, PropertyDefinition.of(PropertyType.UUID));</b>
&nbsp;                }},
<b class="fc">&nbsp;                ListOrderedSet.listOrderedSet(Set.of(&quot;uuid&quot;))</b>
&nbsp;        );
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Connection connection = this.sqlgGraph.tx().getConnection();</b>
<b class="pc">&nbsp;        try (Statement statement = connection.createStatement()) {</b>
<b class="fc">&nbsp;            String sql = String.format(</b>
&nbsp;                    &quot;CREATE SCHEMA \&quot;%s\&quot;;&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="fc">&nbsp;            sql = String.format(</b>
&nbsp;                    &quot;IMPORT FOREIGN SCHEMA \&quot;%s\&quot; FROM SERVER \&quot;%s\&quot; INTO \&quot;%s\&quot; OPTIONS (import_default &#39;true&#39;);&quot;,
&nbsp;                    &quot;A&quot;,
&nbsp;                    &quot;sqlgraph_fwd_server&quot;,
&nbsp;                    &quot;A&quot;
&nbsp;            );
<b class="fc">&nbsp;            statement.execute(sql);</b>
<b class="pc">&nbsp;        }</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        this.sqlgGraph.getTopology().importForeignSchemas(Set.of(this.sqlgGraphFdw.getTopology().getSchema(&quot;A&quot;).orElseThrow()));</b>
<b class="fc">&nbsp;        Assert.assertTrue(this.sqlgGraph.getTopology().getSchema(&quot;A&quot;).isPresent());</b>
&nbsp;
<b class="fc">&nbsp;        Vertex a1 = this.sqlgGraph.addVertex(T.label, &quot;A.A&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;name&quot;, &quot;a1&quot;);</b>
<b class="fc">&nbsp;        Vertex a2 = this.sqlgGraph.addVertex(T.label, &quot;A.A&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;name&quot;, &quot;a2&quot;);</b>
<b class="fc">&nbsp;        Vertex b1 = this.sqlgGraph.addVertex(T.label, &quot;A.B&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;name&quot;, &quot;b1&quot;);</b>
<b class="fc">&nbsp;        Vertex b2 = this.sqlgGraph.addVertex(T.label, &quot;A.B&quot;, &quot;uuid&quot;, UUID.randomUUID(), &quot;name&quot;, &quot;b2&quot;);</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b1, &quot;uuid&quot;, UUID.randomUUID());</b>
<b class="fc">&nbsp;        a1.addEdge(&quot;ab&quot;, b2, &quot;uuid&quot;, UUID.randomUUID());</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;ab&quot;, b1, &quot;uuid&quot;, UUID.randomUUID());</b>
<b class="fc">&nbsp;        a2.addEdge(&quot;ab&quot;, b2, &quot;uuid&quot;, UUID.randomUUID());</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().commit();</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.A&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraph.traversal().V().hasLabel(&quot;A.A&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V().hasLabel(&quot;A.B&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraph.traversal().V().hasLabel(&quot;A.B&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, this.sqlgGraphFdw.traversal().E().hasLabel(&quot;A.ab&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(4, this.sqlgGraph.traversal().E().hasLabel(&quot;A.ab&quot;).count().next(), 0L);</b>
&nbsp;
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V(a1.id()).out(&quot;ab&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V(a2.id()).out(&quot;ab&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V(b1.id()).in(&quot;ab&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        Assert.assertEquals(2, this.sqlgGraphFdw.traversal().V(b2.id()).in(&quot;ab&quot;).count().next(), 0L);</b>
<b class="fc">&nbsp;        this.sqlgGraph.tx().rollback();</b>
<b class="fc">&nbsp;        this.sqlgGraphFdw.tx().rollback();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-27 19:01</div>
</div>
</body>
</html>
